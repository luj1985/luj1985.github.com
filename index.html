
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Lu Jun's blog</title>
  <meta name="author" content="Lu Jun">

  
  <meta name="description" content="仿照Awesome窗口管理器的Spiral Layout做了一个Web布局方式。 本来是想作成黄金螺线的，但考虑到屏幕的大小
实际上并不一定是黄金比例的矩形，所以就用每次取屏幕的一半来进行布局。 代码在最新的Firefox, Chrome, Opera，Safari上都是可以运行的。
截图如下， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://luj1985.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Lu Jun's blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!--
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
-->

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lu Jun's blog</a></h1>
  
    <h2>A Little progress every day</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:luj1985.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/10/html5-spiral-layout/">HTML5 Spiral Layout</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-10T10:38:00+08:00" pubdate data-updated="true">Nov 10<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/11/10/html5-spiral-layout/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>仿照<a href="http://awesome.naquadah.org/">Awesome窗口管理器</a>的Spiral Layout做了一个Web布局方式。</p>

<p>本来是想作成<a href="http://en.wikipedia.org/wiki/Golden_spiral">黄金螺线</a>的，但考虑到屏幕的大小
实际上并不一定是<a href="http://en.wikipedia.org/wiki/Golden_ratio">黄金比例</a>的矩形，所以就用每次取屏幕的一半来进行布局。</p>

<p>代码在最新的Firefox, Chrome, Opera，Safari上都是可以运行的。
截图如下，可以通过鼠标滚轮切换内容。</p>

<p><img src="/images/html5-spiral-layout.png"></p>

<p>代码链接: <a href="https://github.com/luj1985/html5/tree/master/layout">https://github.com/luj1985/html5/tree/master/layout</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/25/construct-hadoop-environment-part-5/">Construct Hadoop Environment<br />Part 5 Install Hadoop</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-25T14:49:00+08:00" pubdate data-updated="true">Mar 25<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/03/25/construct-hadoop-environment-part-5/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Finally got here to start real work :)</p>

<h1>Create VM Template</h1>

<h2>Create Linux user to run Hadoop</h2>

<p>Here <em>gentoo</em> is the machine name of my VM, and the fully qualified domain name of this VM is <em>gentoo.hcluster.org</em>, and the IP address is <em>192.168.2.103</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir /hadoop
</span><span class='line'>useradd -d /hadoop -s /bin/bash -g users -G wheel hadoop
</span><span class='line'>passwd hadoop
</span><span class='line'>chown -R hadoop.users /hadoop</span></code></pre></td></tr></table></div></figure>


<h2>Create SSH public key</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh hadoop@gentoo.hcluster.org
</span><span class='line'>ssh-keygen
</span><span class='line'>cp ~/.ssh/id_rsa.pub ~/.ssh/authorized_keys</span></code></pre></td></tr></table></div></figure>


<p>This VM is used as template, if it can connect to itself, it can connect to any VM which derived from it.
Here is an easy way to copy the SSH public key.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh-copy-id -i ~/.ssh/id_dsa.pub hadoop@gentoo.hcluster.org</span></code></pre></td></tr></table></div></figure>


<p>Edit <em>~/.ssh/config</em> to prevent host key checking</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host *.hcluster.org
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  UserKnownHostsFile /dev/null</span></code></pre></td></tr></table></div></figure>


<p>Now it could be able to connect any host which domain is <em>hcluster.org</em> without password checking.</p>

<h2>Install</h2>

<p>Download <a href="http://hadoop.apache.org/">Apache Hadoop</a>, currently the latest version is 1.0.1</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://mirror.bjtu.edu.cn/apache/hadoop/common/stable/hadoop-1.0.1.tar.gz
</span><span class='line'>tar xzf hadoop-1.0.1.tar.gz
</span><span class='line'>ln -s hadoop-1.0.1 hadoop</span></code></pre></td></tr></table></div></figure>


<p>Edit <em>~/.bash_profile</em> to update environment variables</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export HADOOP_COMMON_HOME=/hadoop/hadoop
</span><span class='line'>export PATH=$HADOOP_COMMON_HOME/bin:$PATH</span></code></pre></td></tr></table></div></figure>


<p>Edit <em>$HADOOP_COMMON_HOME/conf/hadoop-env.sh</em>, add <em>JAVA_HOME</em> environment variable setting.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export JAVA_HOME=`java-config --jdk-home`</span></code></pre></td></tr></table></div></figure>


<h1>Configure Apache Hadoop environment</h1>

<p>Here is my environment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---------------------------------------------------------------
</span><span class='line'>|       Domain Name       |   IP Address  |    MAC Address    |
</span><span class='line'>---------------------------------------------------------------
</span><span class='line'>| jobtracker.hcluster.org | 192.168.2.104 | 00:00:00:00:00:04 |
</span><span class='line'>| namenode1.hcluster.org  | 192.168.2.105 | 00:00:00:00:00:05 |
</span><span class='line'>| namenode2.hcluster.org  | 192.168.2.106 | 00:00:00:00:00:06 |
</span><span class='line'>| datanode1.hcluster.org  | 192.168.2.107 | 00:00:00:00:00:07 |
</span><span class='line'>| datanode2.hcluster.org  | 192.168.2.108 | 00:00:00:00:00:08 |
</span><span class='line'>| datanode3.hcluster.org  | 192.168.2.109 | 00:00:00:00:00:09 |
</span><span class='line'>| datanode4.hcluster.org  | 192.168.2.110 | 00:00:00:00:00:10 |
</span><span class='line'>| datanode5.hcluster.org  | 192.168.2.111 | 00:00:00:00:00:11 |
</span><span class='line'>---------------------------------------------------------------</span></code></pre></td></tr></table></div></figure>


<h2><em>$HADOOP_COMMON_HOME/conf/core-site.xml</em></h2>

<p>Hadoop common properties</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0"?&gt;
</span><span class='line'>&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;
</span><span class='line'>
</span><span class='line'>&lt;!-- Put site-specific property overrides in this file. --&gt;
</span><span class='line'>
</span><span class='line'>&lt;configuration&gt;
</span><span class='line'>    &lt;property&gt;
</span><span class='line'>        &lt;name&gt;fs.default.name&lt;/name&gt;
</span><span class='line'>        &lt;value&gt;hdfs://namenode1.hcluster.org&lt;/value&gt;
</span><span class='line'>    &lt;/property&gt;
</span><span class='line'>&lt;/configuration&gt;</span></code></pre></td></tr></table></div></figure>


<h2><em>$HADOOP_COMMON_HOME/conf/hdfs-site.xml</em></h2>

<p>HDFS properties</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0"?&gt;
</span><span class='line'>&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;
</span><span class='line'>
</span><span class='line'>&lt;!-- Put site-specific property overrides in this file. --&gt;
</span><span class='line'>
</span><span class='line'>&lt;configuration&gt;
</span><span class='line'>    &lt;property&gt;
</span><span class='line'>        &lt;name&gt;dfs.replication&lt;/name&gt;
</span><span class='line'>        &lt;value&gt;2&lt;/value&gt;
</span><span class='line'>    &lt;/property&gt;
</span><span class='line'>&lt;/configuration&gt;</span></code></pre></td></tr></table></div></figure>


<h2><em>$HADOOP_COMMON_HOME/conf/mapred-site.xml</em></h2>

<p>MapReduce properties</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0"?&gt;
</span><span class='line'>&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;
</span><span class='line'>
</span><span class='line'>&lt;!-- Put site-specific property overrides in this file. --&gt;
</span><span class='line'>
</span><span class='line'>&lt;configuration&gt;
</span><span class='line'>    &lt;property&gt;
</span><span class='line'>        &lt;name&gt;mapred.job.tracker&lt;/name&gt;
</span><span class='line'>        &lt;value&gt;jobtracker.hcluster.org:9000&lt;/value&gt;
</span><span class='line'>    &lt;/property&gt;
</span><span class='line'>&lt;/configuration&gt;</span></code></pre></td></tr></table></div></figure>


<p>Must provide port here, seems Hadoop doesn&#8217;t define the default port for job tracker.</p>

<h2><em>$HADOOP_COMMON_HOME/conf/slaves</em></h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>datanode1.hcluster.org
</span><span class='line'>datanode2.hcluster.org
</span><span class='line'>datanode3.hcluster.org
</span><span class='line'>datanode4.hcluster.org
</span><span class='line'>datanode5.hcluster.org</span></code></pre></td></tr></table></div></figure>


<h2><em>$HADOOP_COMMON_HOME/conf/masters</em></h2>

<p>Secondary name node</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>namenode2.hcluster.org</span></code></pre></td></tr></table></div></figure>


<h1>Clone VM</h1>

<p>Remove udev rule file under <em>/etc/udev/rules.d/</em></p>

<h2>70-persistent-net.rules</h2>

<p>When system start it will read udev rules to create device file.
The device file <code>eth0</code> was bind to its MAC address.
That is to say when MAC address changed, the device file name will change too
(Treat as another network card). This makes <em>/etc/init.d/net.eth0</em> invalid.</p>

<p>These rule files can be generated automatically next reboot. So remove this rule file and reboot can adapt MAC changes.</p>

<p>Shutdown this VM, and create several clones to construct Apache Hadoop Cluster</p>

<h2>Change the hostname</h2>

<p>Here the VMs are cloned from one template, all the VM hostnames are the same.</p>

<p>During Hadoop execution, job tracker will <code>map</code> the task to every task tracker node, when <code>map</code> finished it will do the <code>reduce</code>, task trackers trying to copy
data to <code>reduce</code> machine, but here Hadoop seems use <code>hostname</code> to connect the machine.<br/>
Host Name is different from Domain Name, in order to make Hadoop work, I have to make them same</p>

<p>Edit <em>/etc/conf.d/hostname</em> for every node, then restart hostname service</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh root@jobtracker.hcluster.org "echo hostname=\\\"jobtracker\\\" &gt; /etc/conf.d/hostname;/etc/init.d/hostname restart"
</span><span class='line'>ssh root@namenode1.hcluster.org "echo hostname=\\\"namenode1\\\" &gt; /etc/conf.d/hostname;/etc/init.d/hostname restart"
</span><span class='line'>ssh root@namenode2.hcluster.org "echo hostname=\\\"namenode2\\\" &gt; /etc/conf.d/hostname;/etc/init.d/hostname restart"
</span><span class='line'>ssh root@datanode1.hcluster.org "echo hostname=\\\"datanode1\\\" &gt; /etc/conf.d/hostname;/etc/init.d/hostname restart"
</span><span class='line'>ssh root@datanode2.hcluster.org "echo hostname=\\\"datanode2\\\" &gt; /etc/conf.d/hostname;/etc/init.d/hostname restart"
</span><span class='line'>ssh root@datanode3.hcluster.org "echo hostname=\\\"datanode3\\\" &gt; /etc/conf.d/hostname;/etc/init.d/hostname restart"
</span><span class='line'>ssh root@datanode4.hcluster.org "echo hostname=\\\"datanode4\\\" &gt; /etc/conf.d/hostname;/etc/init.d/hostname restart"
</span><span class='line'>ssh root@datanode5.hcluster.org "echo hostname=\\\"datanode5\\\" &gt; /etc/conf.d/hostname;/etc/init.d/hostname restart"</span></code></pre></td></tr></table></div></figure>


<h1>Start Apache Hadoop cluster</h1>

<p>Log into <code>namenode1</code> with <code>hadoop</code> account</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh hadoop@namenode1.hcluster.org</span></code></pre></td></tr></table></div></figure>


<p>Format namenode and start cluster</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hadoop namenode -format
</span><span class='line'>start-all.sh</span></code></pre></td></tr></table></div></figure>


<p>after cluster started, view logs to find whether cluster was started successfully.
Here I found job tracker has errors</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2012-04-07 13:23:26,317 FATAL org.apache.hadoop.mapred.JobTracker: java.net.BindException: Problem binding to jobtracker.hcluster.org/192.168.2.104:9000 : Cannot assign requested address
</span><span class='line'>    at org.apache.hadoop.ipc.Server.bind(Server.java:227)
</span><span class='line'>    at org.apache.hadoop.ipc.Server$Listener.&lt;init&gt;(Server.java:301)
</span><span class='line'>    at org.apache.hadoop.ipc.Server.&lt;init&gt;(Server.java:1483)
</span><span class='line'>    at org.apache.hadoop.ipc.RPC$Server.&lt;init&gt;(RPC.java:545)
</span><span class='line'>    at org.apache.hadoop.ipc.RPC.getServer(RPC.java:506)
</span><span class='line'>    at org.apache.hadoop.mapred.JobTracker.&lt;init&gt;(JobTracker.java:2306)
</span><span class='line'>    at org.apache.hadoop.mapred.JobTracker.&lt;init&gt;(JobTracker.java:2192)
</span><span class='line'>    at org.apache.hadoop.mapred.JobTracker.&lt;init&gt;(JobTracker.java:2186)
</span><span class='line'>    at org.apache.hadoop.mapred.JobTracker.startTracker(JobTracker.java:300)
</span><span class='line'>    at org.apache.hadoop.mapred.JobTracker.startTracker(JobTracker.java:291)
</span><span class='line'>    at org.apache.hadoop.mapred.JobTracker.main(JobTracker.java:4978)
</span><span class='line'>Caused by: java.net.BindException: Cannot assign requested address
</span><span class='line'>    at sun.nio.ch.Net.bind(Native Method)
</span><span class='line'>    at sun.nio.ch.ServerSocketChannelImpl.bind(ServerSocketChannelImpl.java:137)
</span><span class='line'>    at sun.nio.ch.ServerSocketAdaptor.bind(ServerSocketAdaptor.java:77)
</span><span class='line'>    at org.apache.hadoop.ipc.Server.bind(Server.java:225)
</span><span class='line'>    ... 10 more
</span></code></pre></td></tr></table></div></figure>


<p>I don&#8217;t know why this happened, but I could start job tracker on machine <code>jobtracker.hcluster.org</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh hadoop@jobtracker.hcluster.org
</span><span class='line'>hadoop-daemon.sh start jobtracker</span></code></pre></td></tr></table></div></figure>


<h1>Test Cluster</h1>

<p>Follow the offical Apache Hadoop examples</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hadoop fs -put conf input
</span><span class='line'>hadoop jar hadoop-examples-1.0.1.jar grep input output 'dfs[a-z.]+'</span></code></pre></td></tr></table></div></figure>


<h1>Postscript</h1>

<p>Though Hadoop could runs on this &#8220;Cluster&#8221;, but the performance is very low.
I think I&#8217;d better use Hadoop Pseudo-Distributed mode instead&#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/24/construct-hadoop-environment-part-4/">Construct Hadoop Environment<br />Part 4 DNS Server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-24T17:43:00+08:00" pubdate data-updated="true">Mar 24<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/03/24/construct-hadoop-environment-part-4/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&#8217;s hard to remember IP address when the amount of machine grows, configure a DNS sever can reduce much pain.</p>

<h1>DHCP static IP address</h1>

<p>It&#8217;s better to assign static IP address which will be used by DNS.</p>

<p>So I configure some static IP addresses associate with MAC address in my router (DHCP).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MAC Address         IP Address
</span><span class='line'>00:00:00:00:00:03   192.168.2.103
</span><span class='line'>00:00:00:00:00:04   192.168.2.104
</span><span class='line'>00:00:00:00:00:05   192.168.2.105
</span><span class='line'>00:00:00:00:00:06   192.168.2.106
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Then every time when VM&#8217;s MAC address was assigned, the IP address was assigned too.</p>

<h1>Construct DNS server</h1>

<h2>Instll <em>BIND</em></h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo "net-dns/bind -berkdb" &gt;&gt; /etc/portage/package.use
</span><span class='line'>emerge -av net-dns/bind
</span><span class='line'>rc-update add named default
</span><span class='line'>/etc/init.d/named start</span></code></pre></td></tr></table></div></figure>


<p>I choose <code>hcluster.org</code> as my domain name</p>

<h2>Configure domain <code>hcluster.org</code></h2>

<p>By default <code>net-dns/bind</code> supports <code>localhost</code> zone already.</p>

<p>Modify <em>/etc/resolv.conf</em>, change the <em>nameserver</em> point to my own DNS server, and do some a test</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo "nameserver 127.0.0.1" &gt; /etc/resolv.conf
</span><span class='line'>host localhost</span></code></pre></td></tr></table></div></figure>


<p>If everything is OK, the output lines are like</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>localhost has address 127.0.0.1
</span><span class='line'>localhost has IPv6 address ::1</span></code></pre></td></tr></table></div></figure>


<h2>Edit <em>/etc/bind/named.conf</em></h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>acl "xfer" { none; };
</span><span class='line'>acl "trusted" { 127.0.0.0/8; 192.168.2.0/24; };
</span><span class='line'>
</span><span class='line'>options {
</span><span class='line'>    directory "/var/bind";
</span><span class='line'>    pid-file "/var/run/named/named.pid";
</span><span class='line'>    empty-zones-enable no;
</span><span class='line'>
</span><span class='line'>    listen-on-v6 { none; };
</span><span class='line'>    listen-on { 127.0.0.1; 192.168.2.101; };
</span><span class='line'>
</span><span class='line'>    allow-query { trusted; };
</span><span class='line'>    allow-query-cache { trusted; };
</span><span class='line'>    allow-recursion { trusted; };
</span><span class='line'>    allow-transfer { none; };
</span><span class='line'>    allow-update { none; };
</span><span class='line'>
</span><span class='line'>    forward first;
</span><span class='line'>    forwarders { 8.8.8.8; 8.8.8.4; };
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>include "/etc/bind/rndc.key";
</span><span class='line'>controls { inet 127.0.0.1 port 953 allow { 127.0.0.1/32; } keys { "rndc-key"; }; };
</span><span class='line'>
</span><span class='line'>zone "." in { type hint; file "/var/bind/root.cache"; };
</span><span class='line'>zone "localhost" IN { type master; file "pri/localhost.zone"; notify no; };
</span><span class='line'>zone "127.in-addr.arpa" IN { type master; file "pri/127.zone"; notify no; };
</span><span class='line'>zone "hcluster.org" IN { type master; file "pri/hcluster.org.zone"; notify no; };
</span><span class='line'>zone "2.168.192.in-addr.arpa" IN { type master; file "pri/2.168.192.zone"; notify no; };</span></code></pre></td></tr></table></div></figure>


<h2>Add DNS record</h2>

<h3>Edit <em>/var/bind/pri/hcluster.org.zone</em></h3>

<p>Hostname to IP address.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$TTL 1W
</span><span class='line'>@           IN      SOA     homuculus.org. root (
</span><span class='line'>                                      2008122601 ; Serial
</span><span class='line'>                                      28800      ; Refresh
</span><span class='line'>                                      14400      ; Retry
</span><span class='line'>                                      604800     ; Expire - 1 week
</span><span class='line'>                                      86400 )    ; Minimum
</span><span class='line'>            IN      NS      ns
</span><span class='line'>ns          IN      A       192.168.2.101
</span><span class='line'>router      IN      A       192.168.2.1
</span><span class='line'>hypervisor  IN      A       192.168.2.101
</span><span class='line'>
</span><span class='line'>gentoo      IN      A       192.168.2.103
</span><span class='line'>jobtracker  IN      A       192.168.2.104
</span><span class='line'>namenode1   IN      A       192.168.2.105
</span><span class='line'>namenode2   IN      A       192.168.2.106
</span><span class='line'>datanode1   IN      A       192.168.2.107
</span><span class='line'>datanode2   IN      A       192.168.2.108
</span><span class='line'>datanode3   IN      A       192.168.2.109
</span><span class='line'>datanode4   IN      A       192.168.2.110
</span><span class='line'>datanode5   IN      A       192.168.2.111</span></code></pre></td></tr></table></div></figure>


<h3>Edit <em>/var/bind/pri/2.168.192.zone</em></h3>

<p>IP address to hostname.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RIGIN 2.168.192.in-addr.arpa.
</span><span class='line'>$TTL 1W
</span><span class='line'>@       IN SOA      hcluster.org. root.hcluster.org. (
</span><span class='line'>                       2008122601      ; serial
</span><span class='line'>                       3H              ; refresh
</span><span class='line'>                       15M             ; retry
</span><span class='line'>                       1W              ; expiry
</span><span class='line'>                       1D )            ; minimum
</span><span class='line'>
</span><span class='line'>        IN NS       ns.hcluster.org.
</span><span class='line'>101     IN PTR      ns.hcluster.org.
</span><span class='line'>101     IN PTR      hypervisor.hcluster.org.
</span><span class='line'>1       IN PTR      router.hcluster.org.
</span><span class='line'>
</span><span class='line'>103     IN PTR      gentoo.hcluster.org.
</span><span class='line'>104     IN PTR      jobtracker.hadoop.hcluster.org.
</span><span class='line'>105     IN PTR      namenode1.hadoop.hcluster.org.     
</span><span class='line'>106     IN PTR      namenode2.hadoop.hcluster.org.
</span><span class='line'>107     IN PTR      datanode1.hadoop.hcluster.org.
</span><span class='line'>108     IN PTR      datanode2.hadoop.hcluster.org.
</span><span class='line'>109     IN PTR      datanode3.hadoop.hcluster.org.     
</span><span class='line'>110     IN PTR      datanode4.hadoop.hcluster.org.     
</span><span class='line'>111     IN PTR      datanode5.hadoop.hcluster.org.</span></code></pre></td></tr></table></div></figure>


<h3>Permission</h3>

<p>Because <code>named</code> service was run as <code>named</code> user, need to change zone file permission.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chgrp named /var/bind/pri/*</span></code></pre></td></tr></table></div></figure>


<p>Reload configuration file and do some test</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rndc reload
</span><span class='line'>host jobtracker.hcluster.org
</span><span class='line'>host 192.168.2.104</span></code></pre></td></tr></table></div></figure>


<p>The test result should like</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>jobtracker.hcluster.org has address 192.168.2.104
</span><span class='line'>104.2.168.192.in-addr.arpa domain name pointer jobtracker.hcluster.org.</span></code></pre></td></tr></table></div></figure>


<h1>Change DHCP configuration on router</h1>

<p>Finally, login the router, change DHCP server configuration, point the DNS information to my own DNS server. And specify the default domain name as <em>hcluster.org</em></p>

<p>Then after client DHCP IP address renewed, the <em>/etc/resolv.conf</em> is like</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Generated by dhcpcd from wlan0
</span><span class='line'># /etc/resolv.conf.head can replace this line
</span><span class='line'>domain hcluster.org
</span><span class='line'>nameserver 192.168.2.101
</span><span class='line'>nameserver 192.168.1.1
</span><span class='line'># /etc/resolv.conf.tail can replace this line</span></code></pre></td></tr></table></div></figure>


<p>And I could access machine via short domain name</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>host ns
</span><span class='line'>host ns.hcluster.org
</span><span class='line'>dig -t A ns.hcluster.org</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/17/construct-hadoop-environment-part-3/">Construct Hadoop Environment<br />Part 3 KVM Guest</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-17T11:25:00+08:00" pubdate data-updated="true">Mar 17<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/03/17/construct-hadoop-environment-part-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Plan to construct a KVM guest as template, then clone this template to create new instance.</p>

<p>I still use Gentoo Linux as guest system, and install with minimal components.
In order to run Hadoop, guest machine only need Java environment and SSH support.</p>

<p>My host machine already has portage tree, I could passthrough entire portage partition via <a href="http://www.linux-kvm.org/page/9p_virtio">VirtFS</a></p>

<h1>Install libvirt on hypervisor machine</h1>

<p><em><a href="http://libvirt.org/">libvirt</a></em> is just a front-end of KVM, but it provide many handy tools to manage the virtual machine.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo "app-emulation/libvirt qemu virt-network -lxc" &gt;&gt; /etc/portage/package.use
</span><span class='line'>emerge app-emulation/libvirt
</span><span class='line'>/etc/init.d/libvirtd start
</span><span class='line'>rc-update add libvirtd default</span></code></pre></td></tr></table></div></figure>


<h1>Install management tools on remote client</h1>

<p>On a remote machine, here is my laptop.
Edit <em>/etc/portage/package.keywords</em>, add following line to use the latest one (0.9.1) which has enabled VirtFS configuration options.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app-emulation/virt-manager _~amd64_</span></code></pre></td></tr></table></div></figure>


<p>There is also a command line tools available to manage virtual machines</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh -c qemu+ssh://root@192.168.2.101/system</span></code></pre></td></tr></table></div></figure>


<p>virt-manager use the same manchanism to connect remote host (via SSH tunnel)</p>

<h2>Domain XML</h2>

<p>Use virt-manager to create vm, the domain xml dumped from vm is like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;domain type='kvm'&gt;
</span><span class='line'>  &lt;name&gt;gentoo&lt;/name&gt;
</span><span class='line'>  &lt;uuid&gt;3d0ba141-0f7d-7039-d595-c64abb9c1ba0&lt;/uuid&gt;
</span><span class='line'>  &lt;description&gt;Image for construct Apache Hadoop cluster&lt;/description&gt;
</span><span class='line'>  &lt;memory&gt;1048576&lt;/memory&gt;
</span><span class='line'>  &lt;currentMemory&gt;1048576&lt;/currentMemory&gt;
</span><span class='line'>  &lt;vcpu&gt;1&lt;/vcpu&gt;
</span><span class='line'>  &lt;os&gt;
</span><span class='line'>    &lt;type arch='x86_64' machine='pc-1.0'&gt;hvm&lt;/type&gt;
</span><span class='line'>    &lt;boot dev='hd'/&gt;
</span><span class='line'>    &lt;bootmenu enable='no'/&gt;
</span><span class='line'>  &lt;/os&gt;
</span><span class='line'>  &lt;features&gt;
</span><span class='line'>    &lt;acpi/&gt;
</span><span class='line'>    &lt;apic/&gt;
</span><span class='line'>    &lt;pae/&gt;
</span><span class='line'>  &lt;/features&gt;
</span><span class='line'>  &lt;cpu mode='custom' match='exact'&gt;
</span><span class='line'>    &lt;model fallback='allow'&gt;qemu64&lt;/model&gt;
</span><span class='line'>  &lt;/cpu&gt;
</span><span class='line'>  &lt;clock offset='utc'/&gt;
</span><span class='line'>  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
</span><span class='line'>  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
</span><span class='line'>  &lt;on_crash&gt;restart&lt;/on_crash&gt;
</span><span class='line'>  &lt;devices&gt;
</span><span class='line'>    &lt;emulator&gt;/usr/bin/qemu-kvm&lt;/emulator&gt;
</span><span class='line'>    &lt;disk type='file' device='disk'&gt;
</span><span class='line'>      &lt;driver name='qemu' type='qcow2'/&gt;
</span><span class='line'>      &lt;source file='/hadoopimages/gentoo.img'/&gt;
</span><span class='line'>      &lt;target dev='vda' bus='virtio'/&gt;
</span><span class='line'>      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;
</span><span class='line'>    &lt;/disk&gt;
</span><span class='line'>    &lt;disk type='file' device='cdrom'&gt;
</span><span class='line'>      &lt;driver name='qemu' type='raw'/&gt;
</span><span class='line'>      &lt;target dev='hdc' bus='ide'/&gt;
</span><span class='line'>      &lt;readonly/&gt;
</span><span class='line'>      &lt;address type='drive' controller='0' bus='1' unit='0'/&gt;
</span><span class='line'>    &lt;/disk&gt;
</span><span class='line'>    &lt;controller type='usb' index='0'&gt;
</span><span class='line'>      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/&gt;
</span><span class='line'>    &lt;/controller&gt;
</span><span class='line'>    &lt;controller type='ide' index='0'&gt;
</span><span class='line'>      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/&gt;
</span><span class='line'>    &lt;/controller&gt;
</span><span class='line'>    &lt;filesystem type='mount' accessmode='passthrough'&gt;
</span><span class='line'>      &lt;driver type='path'/&gt;
</span><span class='line'>      &lt;source dir='/usr/portage'/&gt;
</span><span class='line'>      &lt;target dir='/hostportage'/&gt;
</span><span class='line'>      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/&gt;
</span><span class='line'>    &lt;/filesystem&gt;
</span><span class='line'>    &lt;interface type='bridge'&gt;
</span><span class='line'>      &lt;mac address='00:00:00:00:00:03'/&gt;
</span><span class='line'>      &lt;source bridge='br0'/&gt;
</span><span class='line'>      &lt;model type='virtio'/&gt;
</span><span class='line'>      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;
</span><span class='line'>    &lt;/interface&gt;
</span><span class='line'>    &lt;serial type='pty'&gt;
</span><span class='line'>      &lt;target port='0'/&gt;
</span><span class='line'>    &lt;/serial&gt;
</span><span class='line'>    &lt;console type='pty'&gt;
</span><span class='line'>      &lt;target type='serial' port='0'/&gt;
</span><span class='line'>    &lt;/console&gt;
</span><span class='line'>    &lt;input type='mouse' bus='ps2'/&gt;
</span><span class='line'>    &lt;graphics type='vnc' port='-1' autoport='yes' keymap='en-us'/&gt;
</span><span class='line'>    &lt;video&gt;
</span><span class='line'>      &lt;model type='cirrus' vram='9216' heads='1'/&gt;
</span><span class='line'>      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
</span><span class='line'>    &lt;/video&gt;
</span><span class='line'>    &lt;memballoon model='virtio'&gt;
</span><span class='line'>      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/&gt;
</span><span class='line'>    &lt;/memballoon&gt;
</span><span class='line'>  &lt;/devices&gt;
</span><span class='line'>&lt;/domain&gt;</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Choose generic CPU, then this VM should be able to port to other KVM based hypervisor</li>
<li>Share hypervisor file system, map <code>/usr/portage</code> to <code>/hostportage</code></li>
<li>Enable virtio on hard disk and network card</li>
</ul>


<h2>Install Gentoo Linux (guest)</h2>

<p>By default, Gentoo installation media kernel do not support <code>9p</code> which is the filesystem VirtFS used.
So here I use Ubuntu LiveCD instead.</p>

<p>Run <code>sudo -i</code> to grab a root prompt.</p>

<h3>Create partition</h3>

<p>I choose <code>VirtIO</code> as my virtual hard disk driver, the disk label is /dev/vda.</p>

<p>Run <code>fdisk /dev/vda</code> to create disk partition.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>   Device Boot      Start         End      Blocks   Id  System
</span><span class='line'>/dev/vda1   *        2048       22527       10240   83  Linux
</span><span class='line'>/dev/vda2           22528      432127      204800   83  Linux
</span><span class='line'>/dev/vda3          432128    40959999    20206592   83  Linux
</span></code></pre></td></tr></table></div></figure>


<h3>Create and mount file system</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkfs.ext4 /dev/vda3
</span><span class='line'>mkdir /mnt/gentoo
</span><span class='line'>mount /dev/vda3 /mnt/gentoo
</span><span class='line'>
</span><span class='line'>mkfs.ext4 dev/vda1
</span><span class='line'>mkdir /mnt/gentoo/boot
</span><span class='line'>mount /dev/vda1 /mnt/gentoo
</span><span class='line'>
</span><span class='line'>mkswap /dev/vda2
</span><span class='line'>swapon /dev/vda2
</span><span class='line'>
</span><span class='line'>cd /mnt/gentoo
</span><span class='line'>tar xjpf stage3-amd64-20120301.tar.bz2
</span><span class='line'>
</span><span class='line'>mkdir /mnt/gentoo/usr/portage
</span><span class='line'>mount -t 9p -otrans=virtio,version=9p2000.L /hostportage /mnt/gentoo/usr/portage
</span><span class='line'>
</span><span class='line'>mount -o bind /proc /mnt/gentoo/proc
</span><span class='line'>mount -o bndd /sys  /mnt/gentoo/sys
</span><span class='line'>mount -o bind /dev  /mnt/gentoo/dev</span></code></pre></td></tr></table></div></figure>


<h3>System configuration</h3>

<h4>DNS resolve</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp -L /etc/resolve.conf /mnt/gentoo/etc</span></code></pre></td></tr></table></div></figure>


<h4>make.conf</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CFLAGS="-O2 -pipe -fomit-frame-pointer"
</span><span class='line'>CXXFLAGS="${CFLAGS}"
</span><span class='line'>CHOST="x86_64-pc-linux-gnu"
</span><span class='line'>
</span><span class='line'>USE="mmx sse sse2 -X -gnome -gtk -ipv6 -kde -qt -cups -alsa"</span></code></pre></td></tr></table></div></figure>


<h3>Chroot</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chroot /mnt/gentoo /bin/bash
</span><span class='line'>env-update
</span><span class='line'>source /etc/profile</span></code></pre></td></tr></table></div></figure>


<h3>Configure the new system</h3>

<p>Edit /etc/fstab</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UUID=b65f0153-1cbf-4b3c-83f0-967781e62cea /boot ext4 noatime 1 2
</span><span class='line'>UUID=6a2fd05c-058f-4fee-a8b6-8cdef2d9c4ad none  swap sw      0 0
</span><span class='line'>UUID=b3a6d092-1ef2-4855-b296-af56ee653b54 /     ext4 noatime 0 1
</span><span class='line'>/hostportage /usr/portage  9p  trans=virtio,version=9p2000.L 0 0</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>passwd
</span><span class='line'>eselect profile set 7
</span><span class='line'>
</span><span class='line'>echo "en_US.UTF-8 UTF-8" &gt;&gt; /etc/locale.gen
</span><span class='line'>locale-gen
</span><span class='line'>
</span><span class='line'>cp /usr/share/zoneinfo/UTC /etc/localtime
</span><span class='line'>echo "UTC" &gt; /etc/timezone
</span><span class='line'>
</span><span class='line'>echo config_eth0=\"dhcp\" &gt;&gt; /etc/conf.d/net
</span><span class='line'>
</span><span class='line'>emerge dhcpcd gentoo-sources
</span><span class='line'>
</span><span class='line'>ln -s /etc/init.d/net.lo /etc/init.d/net.eth0
</span><span class='line'>rc-update add net.eth0 default
</span><span class='line'>
</span><span class='line'>rc-update add sshd default
</span><span class='line'>
</span><span class='line'>echo "en_US.UTF-8 UTF-8" &gt;&gt; /etc/locale.gen
</span><span class='line'>locale-gen</span></code></pre></td></tr></table></div></figure>


<h3>Kernel configuration</h3>

<h4>Kernel must contains <em>virtio</em> drivers</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Processor type and features
</span><span class='line'>  [*] Paravirtualized guest support
</span><span class='line'>    [*] KVM paravirtualized clock
</span><span class='line'>    [*] KVM Guest support
</span><span class='line'>    [*] Enable paravirtualization code
</span><span class='line'>  [*] Allow for memory hot-add
</span><span class='line'>  [*]   Allow for memory hot remove
</span><span class='line'>  [*] Page migration
</span><span class='line'>
</span><span class='line'>Bus options
</span><span class='line'>  [*] Message signaled Interrupts (MSI and MSI-X)
</span><span class='line'>  &lt;M&gt; Support for PCI Hotplug
</span><span class='line'>
</span><span class='line'>Device Drivers
</span><span class='line'>  [*] Block devices
</span><span class='line'>    &lt;*&gt; Virtio block driver
</span><span class='line'>  [*] Network device support
</span><span class='line'>    &lt;*&gt; Virtio network driver
</span><span class='line'>  Character devices
</span><span class='line'>    &lt;*&gt; Virtio console
</span><span class='line'>  &lt;*&gt; Hardware Random Number Generator Core support
</span><span class='line'>    &lt;*&gt; VirtIO Random number Generator support
</span><span class='line'>  Virtio drivers
</span><span class='line'>    &lt;*&gt; PCI driver for virtio devices
</span><span class='line'>    &lt;*&gt; Virtio balloon driver
</span><span class='line'>    &lt;*&gt; Platform bus driver for memory mapped virtio devices</span></code></pre></td></tr></table></div></figure>


<h4>Configure kernel for <em>virtfs</em> support</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[*] Networking support
</span><span class='line'>  &lt;M&gt; Plan 9 Resource Sharing Support
</span><span class='line'>    &lt;M&gt; 9p Virtio Transport
</span><span class='line'>
</span><span class='line'>File systems
</span><span class='line'>  [*] Network File Systems
</span><span class='line'>    &lt;M&gt; Plan 9 Resource Sharing Support
</span><span class='line'>      [*] 9P POSIX Access Control</span></code></pre></td></tr></table></div></figure>


<h3>Install Grub</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grep -v rootfs /proc/mounts &gt; /etc/mtab
</span><span class='line'>emerge -av grub-static</span></code></pre></td></tr></table></div></figure>


<p>Because Grub Legacy cannot recognize VirtIO disk automatically, need to edit <code>/boot/grub/device.map</code> first</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(hd0)   /dev/vda</span></code></pre></td></tr></table></div></figure>


<p>Then install Grub to MBR</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grub-install --no-floppy /dev/vda</span></code></pre></td></tr></table></div></figure>


<p>Edit /boot/grub/grub.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>default 0
</span><span class='line'>timeout 1
</span><span class='line'>
</span><span class='line'>title Gentoo KVM guest 3.2.1-r2
</span><span class='line'>root (hd0,0)
</span><span class='line'>kernel /boot/vmlinuz-3.2.1-gentoo-r2 root=/dev/vda3</span></code></pre></td></tr></table></div></figure>


<h3>Install JDK</h3>

<p>Hadoop require Java envrionment, so install jdk</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>emerge -av jdk</span></code></pre></td></tr></table></div></figure>


<p>find <em>JAVA_HOME</em> via command</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java-config --jdk-home</span></code></pre></td></tr></table></div></figure>


<h2>Compact the KVM guest image</h2>

<p>KVM guest disk format is <code>qcow2</code>, after system installation the disk size has grew very big, but
in fact most of them are empty (File created, then deleted)</p>

<p>Firstly, shutdown the KVM guest machine, then run following command to compact the image size</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>qemu convert -c -f qcow2 -O qcow2 hadoop.img hadoop.compact.img</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/14/construct-hadoop-environment-part-2/">Construct Hadoop Environment<br />Part 2 KVM Host</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-14T01:03:00+08:00" pubdate data-updated="true">Mar 14<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/03/14/construct-hadoop-environment-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>KVM has two components</p>

<ul>
<li>A device driver for managing the virtulization hardware; this driver exposes its capabilities via a character device <em>/dev/kvm</em></li>
<li>A user-space component for emulating PC hardware; this is a lightly modified <em>QEMU</em> process.</li>
</ul>


<p>The modified <em>QEMU</em> process <em>mmap()</em> the guest&#8217;s physical memory and calls the kernel mode driver to execute in guest mode.</p>

<p>The I/O model is directly derived from <em>QEMU</em>&#8217;s, with support for copy-on-write disk images and other <em>QEMU</em> features.
But use <em>QEMU</em> to do full virtualization will reduce the performance, so KVM introduce VirtIO to perform paravirtualization,
notice guest machine that it was running in a virtual environment.</p>

<p><a href="http://www.ibm.com/developerworks/linux/library/l-virtio/">Here</a> is a very good document described the VirtIO.</p>

<h1>KVM based hypervisor configuration</h1>

<h2>Hardware</h2>

<p>CPU must have virtualization instruction set support</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>grep '(vmx|svm)' /proc/cpuinfo</span></code></pre></td></tr></table></div></figure>


<ul>
<li>svm = secure virtual machine (AMD)</li>
<li>vmx = virtual machine extensions (Intel)</li>
</ul>


<p>My CPU is AMD based, the instruction set <code>svm</code> was found.</p>

<h2>KVM host(hypervisor) configuration</h2>

<p>Tune kernel to support KVM, and enable network protocol to support bridge.</p>

<h3>Kernel configuration (with paravirtualization support)</h3>

<p><a href="http://www.linux-kvm.org/page/Tuning_Kernel#Kernel_for_host">Here</a> is a official document about tuning the kernel of KVM host</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>General setup
</span><span class='line'>  [*] Control Group support
</span><span class='line'>
</span><span class='line'>Processor type and features
</span><span class='line'>  [*] High Resolution Timer Support
</span><span class='line'>  [*] Allow for memory compaction
</span><span class='line'>  [*] Page migration
</span><span class='line'>  [*] Enable KSM for page merging
</span><span class='line'>  [*] transparent Hugepage Support
</span><span class='line'>
</span><span class='line'>Device Drivers
</span><span class='line'>  Character devices
</span><span class='line'>    [*] HPET - High Precision Event Timer
</span><span class='line'>
</span><span class='line'>[*] Virtualization
</span><span class='line'>  &lt;M&gt; Kernel-based Virtual Machine (KVM) support
</span><span class='line'>  &lt; &gt;   KVM for Intel processors support
</span><span class='line'>  &lt;M&gt;   KVM for AMD processors support
</span><span class='line'>  &lt;M&gt; Host kernel accelerator for virtio net</span></code></pre></td></tr></table></div></figure>


<h3>Network bridge support</h3>

<p>I want to connect to KVM guest remotely, need enable bridge networking.</p>

<p>To enable network bridge need following kernel options.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[*] Networking support
</span><span class='line'>  Networking options
</span><span class='line'>    &lt;M&gt; 802.1d Ethernet Bridging
</span><span class='line'>    &lt;M&gt; 802.1Q VLAN Support
</span><span class='line'>
</span><span class='line'>Device Drivers
</span><span class='line'>[*] Network device support
</span><span class='line'>  [*] Network core driver support
</span><span class='line'>    &lt;M&gt; Universal TUN/TAP device driver support</span></code></pre></td></tr></table></div></figure>


<h3>/etc/conf.d/modules</h3>

<p>Create config file to load kernel module</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>modules="kvm-amd bridge 8021q tun vhost-net"</span></code></pre></td></tr></table></div></figure>


<h2>User space packages</h2>

<p>emerge following user space tools</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app-emulation/qemu-kvm qemu-ifup xattr tls
</span><span class='line'>net-misc/bridge-utils</span></code></pre></td></tr></table></div></figure>


<h1>Bridge network configuration</h1>

<p>Direct bridging (guests use an IP address on the same subnet as the host)</p>

<blockquote><p>The most transparent option to allow your guests access to the internet is the &#8220;virtual hub&#8221;. In this scheme, the bridge connects eth0 and your tuntap interfaces together, routing packets as if it were a real &#8220;old fashioned&#8221; hub (not a switch). The key to this approach is to make sure you have unique mac addresses on both the host&#8217;s tuntap interface as well as the guest.</p><footer><strong>KVM</strong> <cite><a href='http://en.gentoo-wiki.com/wiki/KVM'>en.gentoo-wiki.com/wiki/KVM/&hellip;</a></cite></footer></blockquote>


<p>I use QEMU Tap networking backend, <a href="http://wiki.qemu.org/Documentation/Networking#Tap">it require to invoke QEMU as root</a></p>

<h2>/etc/init.d</h2>

<p>Create network device</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ln -s /etc/init.d/net.lo /etc/init.d/net.br0
</span><span class='line'>rc-update add net.br0 default</span></code></pre></td></tr></table></div></figure>


<h2>Enable KSM</h2>

<p>KSM was not enabled by default.</p>

<p>Create file <em>/etc/local.d/ksm.start</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 1 &gt; /sys/kernel/mm/ksm/run</span></code></pre></td></tr></table></div></figure>


<p>Grant executable permission</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chmod a+x /etc/local.d/ksm.start</span></code></pre></td></tr></table></div></figure>


<p>In Gentoo, all script in directory <em>/etc/local.d</em> will be executed by <em>/etc/init.d/local</em> when system starting up</p>

<h2>/etc/conf.d/net</h2>

<p>Network startup options</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bridge_br0="eth0"
</span><span class='line'>config_eth0="null"
</span><span class='line'>
</span><span class='line'>brctl_br0="setfd 0 sethello 1 stp off"
</span><span class='line'>config_br0="dhcp"
</span><span class='line'>
</span><span class='line'>depend_br0() {
</span><span class='line'>    need net.eth0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Create script to manage network device</h2>

<p>I enabled <code>qemu-ifup</code> USE flag of app-emulation/qemu-kvm package.
But the script were under <em>/etc/qemu/</em> which is not the default location <em>qemu-kvm</em> use.</p>

<p>And the program path in script <em>/etc/qemu/qemu-ifup</em> is hard coded and is not suite for Gentoo system.
So I created the following two scripts instead, and grant executable permission.</p>

<h3>/etc/qemu-ifup</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>switch=$(/sbin/ip route list | awk '/^default / { print $5 }')
</span><span class='line'>/sbin/ifconfig $1 0.0.0.0 up
</span><span class='line'>/sbin/brctl addif ${switch} $1</span></code></pre></td></tr></table></div></figure>


<h3>/etc/qemu-ifdown</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>switch=$(/sbin/ip route list | awk '/^default / { print $5 }')
</span><span class='line'>/sbin/ifconfig $1 0.0.0.0 down
</span><span class='line'>/sbin/brctl delif ${switch} $1</span></code></pre></td></tr></table></div></figure>


<h2>Make configuration take effect</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>modprobe kvm-amd bridge 8021q tun vhost-net
</span><span class='line'>/etc/init.d/net.eth0 restart
</span><span class='line'>/etc/init.d/net.br0 start</span></code></pre></td></tr></table></div></figure>


<p>Or simply reboot the system.</p>

<h1>Test KVM guest machine</h1>

<p>Login hypervisor as root and run following command to create guest machine.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>qemu-img create -f qcow2 -o preallocation=metadata gentoo.img 10G
</span><span class='line'>qemu-kvm -hda gentoo.img -cdrom install-amd64-minimal-20120223.iso \
</span><span class='line'>         -net nic,mac=00:00:00:00:00:01,vlan=0 -net tap,vlan=0 -boot d -vnc :0</span></code></pre></td></tr></table></div></figure>


<p>Use option <code>-vnc :0</code> to open a VNC port, then I could use <code>vncviewer</code> to connect it remotely.
IP address of my KVM host server is 192.168.2.101, then use following command to connect VNC</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vncviewer 192.168.2.101:0</span></code></pre></td></tr></table></div></figure>


<p>After VNC connected, active network card in guest machine, start SSH server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ifconfig eth0 up
</span><span class='line'>dhcpcd eth0
</span><span class='line'>passwd
</span><span class='line'>/etc/init.d/sshd start</span></code></pre></td></tr></table></div></figure>


<p>The guest machine gains IP address 192.168.2.103. Then it should be able to access from outside world.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh root@192.168.2.103</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <img src="http://gravatar.com/avatar/4c41bbce16363f347def49891e4e2aa3?s=150" alt="Gravatar Image" title="Gravatar Image" />
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/11/10/html5-spiral-layout/">HTML5 Spiral Layout</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/25/construct-hadoop-environment-part-5/">Construct Hadoop Environment<br />Part 5 Install Hadoop</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/24/construct-hadoop-environment-part-4/">Construct Hadoop Environment<br />Part 4 DNS Server</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/17/construct-hadoop-environment-part-3/">Construct Hadoop Environment<br />Part 3 KVM Guest</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/14/construct-hadoop-environment-part-2/">Construct Hadoop Environment<br />Part 2 KVM Host</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'luj1985',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Lu Jun -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'luj1985';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
